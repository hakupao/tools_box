# Tools Box 开发文档

本文档提供了工具箱项目的开发指南和技术细节。

## 项目架构

### 整体架构

```
tools_box/
├── src/                      # 源代码根目录
│   ├── main.py              # 程序入口点
│   ├── version.py           # 版本配置文件
│   ├── gui/                 # 图形界面模块
│   │   ├── __init__.py
│   │   ├── main_window.py   # 主窗口类
│   │   └── widgets/         # 各工具窗口组件
│   │       ├── __init__.py
│   │       ├── date_converter.py           # 日期转换窗口
│   │       ├── csv_converter.py            # CSV转XLSX窗口
│   │       ├── xlsx_converter.py           # XLSX转CSV窗口
│   │       ├── fullwidth_halfwidth_converter.py # 全角转半角窗口
│   │       ├── data_cleaner.py             # 数据清洗窗口
│   │       ├── codelist_processor.py       # Codelist处理窗口
│   │       ├── data_masking.py             # 数据模糊化窗口
│   │       ├── csv_quote_remover.py        # CSV引号去除窗口
│   │       ├── edc_site_adder.py           # EDC站点添加窗口
│   │       └── xlsx_file_restructuring.py  # XLSX重构窗口
│   └── utils/               # 工具函数模块
│       ├── __init__.py
│       ├── date_utils.py                   # 日期处理工具
│       ├── csv_to_xlsx_converter.py        # CSV转XLSX处理器
│       ├── xlsx_to_csv_converter.py        # XLSX转CSV处理器
│       ├── fullwidth_to_halfwidth_converter.py # 全角转半角处理器
│       ├── data_cleaning.py                # 数据清洗处理器
│       ├── codelist_process.py             # Codelist处理器
│       ├── data_masking_processor.py       # 数据模糊化处理器
│       ├── csv_quote_remover_processor.py  # CSV引号去除处理器
│       └── restructure_xlsx_file.py        # XLSX重构处理器
├── docs/                    # 文档目录
├── requirements.txt         # 依赖配置
├── tools_box.spec          # PyInstaller打包配置
├── CHANGELOG.md            # 更新日志
└── README.md              # 项目说明
```

### 设计模式

#### MVC 架构
- **Model (utils/)**: 业务逻辑和数据处理
- **View (gui/)**: 用户界面展示
- **Controller (gui/widgets/)**: 用户交互控制

#### 组件化设计
每个工具都采用独立的组件设计：
- 窗口类：负责UI展示和用户交互
- 处理器类：负责具体的业务逻辑
- 工具函数：提供通用的辅助功能

## 开发环境设置

### 1. 环境要求

- **Python**: 3.8+ (推荐 3.9+)
- **操作系统**: Windows 10/11
- **IDE**: 推荐 VS Code 或 PyCharm
- **Git**: 用于版本控制

### 2. 项目设置

```bash
# 克隆项目
git clone [repository-url]
cd tools_box

# 创建虚拟环境
python -m venv venv

# 激活虚拟环境
.\venv\Scripts\activate  # Windows

# 安装依赖
pip install -r requirements.txt
```

### 3. 开发工具配置

#### VS Code 配置

创建 `.vscode/settings.json`:
```json
{
    "python.defaultInterpreterPath": "./venv/Scripts/python.exe",
    "python.linting.enabled": true,
    "python.linting.flake8Enabled": true,
    "python.formatting.provider": "black",
    "python.formatting.blackArgs": ["--line-length=100"],
    "files.encoding": "utf8"
}
```

#### 代码规范工具

安装开发工具：
```bash
pip install black flake8 isort
```

## 核心技术

### GUI 框架

#### Tkinter
- **优势**: Python内置，无额外依赖
- **用法**: 所有窗口继承自 `tk.Toplevel`
- **样式**: 统一的现代化风格设计

#### TkinterDnD2
- **功能**: 实现文件拖拽功能
- **配置**: 每个窗口注册拖拽事件
- **处理**: 统一的文件处理逻辑

### 数据处理

#### Pandas
- **用途**: CSV/Excel文件读写和数据处理
- **配置**: 统一使用 `dtype=str` 保持数据格式
- **编码**: 使用 `utf-8-sig` 处理中文BOM

#### OpenPyXL
- **用途**: Excel文件的深度操作
- **特性**: 支持格式保持和样式处理

### 自动化控制

#### PyAutoGUI
- **用途**: 鼠标键盘自动化控制
- **安全**: 设置 `FAILSAFE = True`
- **配置**: 可调节的点击坐标和延时

## 添加新工具指南

### 1. 创建处理器类

在 `src/utils/` 中创建处理器：

```python
# src/utils/new_tool_processor.py
class NewToolProcessor:
    """新工具处理器"""
    
    def __init__(self):
        """初始化处理器"""
        pass
    
    def process_file(self, input_file: str, output_path: str = None) -> bool:
        """处理文件的主要方法"""
        try:
            # 实现具体处理逻辑
            return True
        except Exception as e:
            print(f"处理失败: {str(e)}")
            return False
```

### 2. 创建窗口组件

在 `src/gui/widgets/` 中创建窗口：

```python
# src/gui/widgets/new_tool.py
import tkinter as tk
from tkinter import ttk, filedialog, messagebox
from tkinterdnd2 import DND_FILES, TkinterDnD
from ...utils.new_tool_processor import NewToolProcessor

class NewToolWindow:
    """新工具窗口"""
    
    def __init__(self, parent, main_window):
        self.window = tk.Toplevel(parent)
        self.window.title("新工具")
        self.window.geometry("800x600")
        self.window.configure(bg='#f0f0f0')
        
        # 保存主窗口引用
        self.main_window = main_window
        
        # 设置拖放
        self.window.drop_target_register(DND_FILES)
        self.window.dnd_bind('<<Drop>>', self.handle_drop)
        
        # 初始化处理器
        self.processor = NewToolProcessor()
        
        self._create_widgets()
    
    def _create_widgets(self):
        """创建界面组件"""
        # 实现界面布局
        pass
```

### 3. 注册到主窗口

修改 `src/gui/main_window.py`:

```python
# 导入新工具
from src.gui.widgets.new_tool import NewToolWindow

# 在按钮配置中添加
self.buttons = [
    # ... 现有按钮
    ("新工具", self.function_new),
]

# 添加对应方法
def function_new(self):
    self.hide()
    NewToolWindow(self.root, self)
```

### 4. 更新版本信息

在 `src/version.py` 中更新功能列表和版本号。

## 打包发布

### 配置文件

`tools_box.spec` 包含完整的打包配置：
- 隐藏导入模块
- 数据文件收集
- 二进制文件过滤
- 优化设置

### 打包流程

```bash
# 清理旧文件
Remove-Item -Path build,dist,temp_tkdnd -Recurse -Force -ErrorAction SilentlyContinue

# 重新打包
python -m PyInstaller tools_box.spec --clean
```

### 打包优化

- 排除不必要的模块
- 压缩和优化设置
- 平台特定的配置

## 测试指南

### 单元测试

为每个处理器编写测试：
```python
# tests/test_new_tool.py
import unittest
from src.utils.new_tool_processor import NewToolProcessor

class TestNewTool(unittest.TestCase):
    def setUp(self):
        self.processor = NewToolProcessor()
    
    def test_process_file(self):
        # 测试用例
        pass
```

### 集成测试

测试完整的用户工作流程：
1. 文件选择和拖拽
2. 参数设置
3. 处理执行
4. 结果验证

## 常见开发问题

### 1. 中文编码问题
**解决方案**: 统一使用 `utf-8-sig` 编码

### 2. 文件路径问题
**解决方案**: 使用 `pathlib` 处理路径，避免硬编码

### 3. 内存占用问题
**解决方案**: 
- 分批处理大文件
- 及时释放不用的对象
- 使用生成器处理大数据集

### 4. GUI 响应问题
**解决方案**: 
- 使用线程处理耗时操作
- 及时更新进度显示
- 提供取消操作功能

## 代码规范

### Python 代码风格

遵循 PEP8 规范：
- 使用 4 个空格缩进
- 行长度限制为 100 字符
- 类名使用 PascalCase
- 函数名使用 snake_case
- 常量使用 UPPER_CASE

### 文档字符串

使用中文文档字符串：
```python
def process_file(self, input_file: str, output_path: str = None) -> bool:
    """
    处理单个文件
    
    Args:
        input_file: 输入文件路径
        output_path: 输出路径，可选
        
    Returns:
        bool: 处理是否成功
    """
```

### 错误处理

统一的错误处理模式：
```python
try:
    # 主要逻辑
    result = process_data()
    return True, result
except FileNotFoundError as e:
    return False, f"文件未找到: {str(e)}"
except Exception as e:
    return False, f"处理失败: {str(e)}"
```

## 贡献指南

### 提交规范

使用 Conventional Commits 格式：
```
feat: 添加新的数据转换工具
fix: 修复文件编码问题  
docs: 更新用户手册
style: 代码格式调整
refactor: 重构数据处理逻辑
test: 添加单元测试
```

### Pull Request 流程

1. Fork 项目仓库
2. 创建功能分支
3. 编写代码和测试
4. 提交 Pull Request
5. 代码审查
6. 合并到主分支

### 代码审查要点

- 功能完整性
- 代码质量
- 测试覆盖率
- 文档完整性
- 用户体验

---

## 联系方式

- **技术讨论**: [待添加]
- **问题反馈**: [待添加]
- **代码审查**: [待添加] 